# 沙箱技术限制说明

## 系统调用

> 提示：此部分已过时，从 rev22 开始沙箱基于 seccomp-bpf 检测系统调用。

sandbox-tiny 不受系统调用限制。

系统调用通过 ptrace 捕获调用，采用白名单放行，详见 sandbox.cpp 中的 `process_syscall` 函数。

涉及文件的系统调用会检查是否有对应权限，详见 [文件许可机制](#文件许可机制)。

## 文件许可机制

文件许可有三种权限：只读、只写、读写，本质是 ACC Mode。

文件权限申请有四种：存在权限、读、写、读写。

| 文件权限申请 | 说明 | 备注 |
| :-: | :-: | :-: |
| 存在权限 | 拥有读、写权限中的任意一种 | 没有文件操作时应该使用此权限，例如处理 dup 系统调用 |
| 读 | 拥有只读/读写权限 | |
| 写 | 拥有只写/读写权限 | |
| 读写 | 拥有读写权限 | 不常用 |

授权按 `(path, mode)` 的方式给出，必须保证 path 的父目录存在。

授权跟随符号链接。授权时，通过 `fs::canonical` 解析父目录的所有符号链接，然后通过 `stat64` 读取父目录的 `(st_dev, st_ino)`作为目录唯一标识符。同时记录授权的文件名和权限。如果相同的路径有多个权限，权限会自动合并。

检查权限时，从父目录开始逐级检查直到根目录检查结束，每一级都检查文件名和权限。

默认放行对以下项目的读取：

```
/etc/ld.so.preload
/etc/ld.so.cache
/lib
/usr/lib
/dev/random
/dev/urandom
/dev/null
/etc/localtime
标准输入流
标准输入流连接到的终端
```

默认放行对以下项目的写入：

```
标准输出/错误流
标准输出/错误流连接到的终端
```

## 计时和超时杀死

程序用时为用户态时间和系统态时间之和，精度为微秒。

评测子进程和主进程都有超时杀死机制：

- 子进程采用程序用时判定超时杀死。
- 主进程采用向子进程发送恢复信号后，子进程运行的实际时间判定超时杀死。这是保底手段，因此超时的限制较给定的限制多一秒。
